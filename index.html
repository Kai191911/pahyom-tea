// ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏ô‡∏±‡∏ö‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏ô memory (‡∏à‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏°‡∏∑‡πà‡∏≠ serverless function ‡∏£‡∏µ‡∏™‡∏ï‡∏≤‡∏£‡πå‡∏ó)
let queueCounter = 0;

export default async function handler(req, res) {
  try {
    // ‡∏≠‡πà‡∏≤‡∏ô body ‡∏à‡∏≤‡∏Å request
    const body = await readBody(req);
    const { message } = body || {};

    if (!message) {
      return res.status(400).json({ error: "Missing 'message' in body" });
    }

    // ‚úÖ ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á "‡∏£‡∏µ‡∏Ñ‡∏¥‡∏ß" ‡∏´‡∏£‡∏∑‡∏≠ "reset queue"
    if (message.trim() === "‡∏£‡∏µ‡∏Ñ‡∏¥‡∏ß" || message.trim().toLowerCase() === "reset queue") {
      queueCounter = 0;
      await sendLineMessage("üîÅ ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏¥‡∏ß‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÅ‡∏•‡πâ‡∏ß");
      return res.status(200).json({ success: true, message: "Queue reset" });
    }

    // ‚úÖ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏¥‡∏ß‡πÉ‡∏´‡∏°‡πà
    queueCounter += 1;
    const messageWithQueue = `üì¶ ‡∏Ñ‡∏¥‡∏ß‡∏ó‡∏µ‡πà ${queueCounter}\n${message}`;

    await sendLineMessage(messageWithQueue);
    res.status(200).json({ success: true, queue: queueCounter });

  } catch (error) {
    console.error("‚ùå ERROR:", error);
    res.status(500).json({ error: "Internal Server Error", details: error.message });
  }
}


// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ LINE

async function sendLineMessage(text) {
  const token = process.env.LINE_TOKEN;
  const userId = "Ua74514c2f5500bca939e5db00814c436"; // <== ‡πÉ‡∏™‡πà userId ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì

  if (!token) throw new Error("Missing LINE_TOKEN in environment variables");

  const response = await fetch("https://api.line.me/v2/bot/message/push", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${token}`
    },
    body: JSON.stringify({
      to: userId,
      messages: [{ type: "text", text }]
    })
  });

  if (!response.ok) {
    const errText = await response.text();
    console.error("LINE API error:", errText);
    throw new Error("LINE API failed: " + errText);
  }
}

// ‚úÖ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡πà‡∏≤‡∏ô body (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÉ‡∏ô Vercel Serverless)
async function readBody(req) {
  return new Promise((resolve, reject) => {
    let data = "";
    req.on("data", chunk => data += chunk);
    req.on("end", () => {
      try {
        resolve(JSON.parse(data));
      } catch {
        resolve({});
      }
    });
    req.on("error", reject);
  });
}
